/* DDL (Data Definition Language) QUERIES */
/* Create database and tables */

/* Removes database called 'BankProcess' if it already has been made.*/
DROP DATABASE IF EXISTS bank_assignment;

/*Create database called 'BankProcess' and use as the default (current) database for subsequent statements.*/
CREATE DATABASE bank_assignment;
USE bank_assignment;

CREATE TABLE branch (
	branch_id INT NOT NULL AUTO_INCREMENT,
    address_id INT NOT NULL, 
    branch_name VARCHAR(30) NOT NULL,
    PRIMARY KEY (branch_id),
    UNIQUE (address_id, branch_name)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;

CREATE TABLE customer (
    customer_id INT NOT NULL AUTO_INCREMENT,
    first_name VARCHAR(100)  NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    date_of_birth date NOT NULL,
    email VARCHAR(255),
    PRIMARY KEY (customer_id),
    UNIQUE (email)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;

CREATE TABLE customer_account ( -- Junction table for many-many relation (join accounts)
	customer_id INT,
    account_id INT,
    PRIMARY KEY (customer_id, account_id) -- Composite key
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE account (
    account_id INT NOT NULL AUTO_INCREMENT,
    customer_id INT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    opening_balance DECIMAL(10,2) NOT NULL DEFAULT 51,
    account_number VARCHAR(8) NOT NULL,
    sort_code VARCHAR(8) NOT NULL,
    create_date DATE DEFAULT now(),
    branch_id INT NOT NULL,
    PRIMARY KEY (account_id),
    UNIQUE(sort_code, account_number)    
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1; 

CREATE TABLE customer_address (
    customer_id INT,
    address_id INT,
    PRIMARY KEY (customer_id, address_id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE address (
	address_id INT NOT NULL AUTO_INCREMENT,
    address_line1 VARCHAR(255) NOT NULL,
    address_line2 VARCHAR(255),
    postal_code VARCHAR(32) NOT NULL,
    state VARCHAR(50) NOT NULL,
    city VARCHAR(50) NOT NULL,
    PRIMARY KEY (address_id),
    UNIQUE(postal_code)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;

CREATE TABLE transactions (
	transaction_id INT NOT NULL AUTO_INCREMENT,
    account_id INT NOT NULL,
    transaction_date DATETIME NOT NULL DEFAULT now(),
    isOutgoing BOOLEAN NOT NULL DEFAULT FALSE,
    isIncoming BOOLEAN NOT NULL DEFAULT FALSE,
    amount DECIMAL(10,2) NOT NULL DEFAULT 0,
    description TEXT DEFAULT 'None',
    PRIMARY KEY (transaction_id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;

CREATE TABLE loans (
	loan_id INT NOT NULL,
    account_id INT NOT NULL,
    monthly_rate DECIMAL(10,2) NOT NULL,
    duration_month INT NOT NULL,
    first_payment DATE NOT NULL,
    monthly_due_date DATE NOT NULL,
    PRIMARY KEY (loan_id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;

CREATE TABLE customer_phone (
    contact_id INT NOT NULL AUTO_INCREMENT,
    customer_id INT NOT NULL,
	contact_number VARCHAR(11) NOT NULL,
    country_code INT NOT NULL,
    type ENUM('landphone','mobile','other') NOT NULL,
    PRIMARY KEY (contact_id)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;


/* Add foreign keys and any neccessary constraints. */
/* KEY : fk_[referencing table name]_[referenced table name]_[referencing field name]. */
ALTER TABLE account ADD CONSTRAINT fk_account_branch_branch_id
FOREIGN KEY (branch_id) REFERENCES branch(branch_id)
ON DELETE CASCADE ON UPDATE CASCADE; -- DOUBLE CHECK IF THIS IS CORRECT VALID OPTION TO USE (also for the ones below)

ALTER TABLE branch ADD CONSTRAINT fk_branch_address_address_id
FOREIGN KEY (address_id) REFERENCES address(address_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE customer_address ADD CONSTRAINT fk_customer_address_customer_customer_id
FOREIGN KEY (customer_id) REFERENCES customer(customer_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE customer_address ADD CONSTRAINT fk_customer_address_address_customer_id
FOREIGN KEY (address_id) REFERENCES address(address_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE customer_account ADD CONSTRAINT fk_customer_account_customer_customer_id
FOREIGN KEY (customer_id) REFERENCES customer(customer_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE customer_account ADD CONSTRAINT fk_customer_account_account_account_id
FOREIGN KEY (account_id) REFERENCES account(account_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE customer_phone ADD CONSTRAINT fk_customer_phone_customer_customer_id
FOREIGN KEY (customer_id) REFERENCES customer(customer_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE transactions ADD CONSTRAINT fk_transactions_account_account_id
FOREIGN KEY (account_id) REFERENCES account(account_id)
ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE loans ADD CONSTRAINT fk_loans_account_account_id
FOREIGN KEY (account_id) REFERENCES account(account_id)
ON DELETE CASCADE ON UPDATE CASCADE;



/* DML (Data Manipulation) QUERIES */

/* Trigger on account table to prevent users entering a opening balance less than 51 */
DELIMITER $$
CREATE TRIGGER account_opening_balance_check BEFORE INSERT ON account
	FOR EACH ROW 
    	BEGIN 
        	IF NEW.opening_balance <= 50.00 THEN
            	SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Your opening balance must be greater then 50.';
            END IF;
        END $$
DELIMITER ;

/* Trigger on transactions table to ensure a transaction isnt both incoming and outgoing */
DELIMITER $$
CREATE TRIGGER transactions_in_out_amount_check BEFORE INSERT ON transactions
	FOR EACH ROW
    	BEGIN
        	IF (NEW.isOutgoing = true and NEW.isIncoming = true) THEN
            	SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Both "isOutgoing" and "isIncoming" columns cannot be set to "true"';
            END IF;
        END $$
DELIMITER ;




/* DCL (Data Control Language) QUERIES */
/* Creating users and setting permissions */

/* Set users and grant permissions */
/* We have 1 read/write user and 1 read user */
CREATE USER IF NOT EXISTS 'admin'@'localhost' IDENTIFIED BY 'AdminUser#2021'; -- Set secure passwords
GRANT SELECT, INSERT, UPDATE, DELETE, INDEX, CREATE, ALTER 
	ON bank_assignment TO 'admin'@'localhost';

CREATE USER IF NOT EXISTS 'read'@'localhost' IDENTIFIED BY 'ReadUser#2021';
GRANT SELECT
	ON bank_assignment.* TO 'read'@'localhost'; /* grant to all tables */

/* Show all privileges users have been given */
SHOW GRANTS FOR 'admin'@'localhost';
SHOW GRANTS FOR 'read'@'localhost';
